<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>æ•°å­¦å…¬å¼èƒŒè¯µåŠ©æ‰‹</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“</text></svg>">
    <!-- KaTeX CSS - å°†è¢«ç¼“å­˜ä¾›ç¦»çº¿ä½¿ç”¨ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #eff6ff 0%, #eef2ff 50%, #faf5ff 100%);
            min-height: 100vh;
            color: #1f2937;
        }

        /* Utility Classes */
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .flex-1 { flex: 1; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }
        .grid { display: grid; }
        .grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-cols-6 { grid-template-columns: repeat(6, 1fr); }
        .text-center { text-align: center; }
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .text-3xl { font-size: 1.875rem; }
        .text-5xl { font-size: 3rem; }
        .text-6xl { font-size: 3.75rem; }
        .font-medium { font-weight: 500; }
        .font-bold { font-weight: 700; }
        .text-white { color: white; }
        .text-gray-400 { color: #9ca3af; }
        .text-gray-500 { color: #6b7280; }
        .text-gray-600 { color: #4b5563; }
        .text-gray-700 { color: #374151; }
        .text-gray-800 { color: #1f2937; }
        .text-blue-500 { color: #3b82f6; }
        .text-blue-600 { color: #2563eb; }
        .text-green-600 { color: #16a34a; }
        .text-red-500 { color: #ef4444; }
        .text-red-600 { color: #dc2626; }
        .text-purple-600 { color: #9333ea; }
        .bg-white { background-color: white; }
        .bg-gray-50 { background-color: #f9fafb; }
        .bg-gray-100 { background-color: #f3f4f6; }
        .bg-gray-200 { background-color: #e5e7eb; }
        .bg-blue-50 { background-color: #eff6ff; }
        .bg-blue-100 { background-color: #dbeafe; }
        .bg-blue-500 { background-color: #3b82f6; }
        .bg-green-50 { background-color: #f0fdf4; }
        .bg-green-100 { background-color: #dcfce7; }
        .bg-purple-50 { background-color: #faf5ff; }
        .bg-purple-100 { background-color: #f3e8ff; }
        .bg-red-50 { background-color: #fef2f2; }
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .rounded-2xl { border-radius: 1rem; }
        .rounded-full { border-radius: 9999px; }
        .shadow { box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .shadow-sm { box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .p-2 { padding: 0.5rem; }
        .p-3 { padding: 0.75rem; }
        .p-4 { padding: 1rem; }
        .p-5 { padding: 1.25rem; }
        .p-6 { padding: 1.5rem; }
        .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
        .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
        .py-8 { padding-top: 2rem; padding-bottom: 2rem; }
        .py-10 { padding-top: 2.5rem; padding-bottom: 2.5rem; }
        .pb-2 { padding-bottom: 0.5rem; }
        .pb-20 { padding-bottom: 5rem; }
        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mt-1 { margin-top: 0.25rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .mt-6 { margin-top: 1.5rem; }
        .mr-1 { margin-right: 0.25rem; }
        .w-6 { width: 1.5rem; }
        .w-10 { width: 2.5rem; }
        .w-full { width: 100%; }
        .h-6 { height: 1.5rem; }
        .h-20 { height: 5rem; }
        .min-h-screen { min-height: 100vh; }
        .max-w-md { max-width: 28rem; }
        .overflow-x-auto { overflow-x: auto; }
        .overflow-y-auto { overflow-y: auto; }
        .whitespace-nowrap { white-space: nowrap; }
        .border { border: 1px solid #e5e7eb; }
        .border-b { border-bottom: 1px solid #e5e7eb; }
        .border-2 { border-width: 2px; }
        .border-gray-300 { border-color: #d1d5db; }
        .border-blue-500 { border-color: #3b82f6; }
        .outline-none { outline: none; }
        .cursor-pointer { cursor: pointer; }
        .hidden { display: none; }
        .fixed { position: fixed; }
        .inset-0 { top: 0; right: 0; bottom: 0; left: 0; }
        .z-50 { z-index: 50; }
        .space-y-3 > * + * { margin-top: 0.75rem; }

        /* Custom Styles */
        .page { display: none; min-height: 100vh; }
        .page.active { display: block; }

        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            padding: 1.25rem;
            margin-bottom: 1rem;
        }

        .formula-display {
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.4);
            border: none;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .btn-primary:active { transform: scale(0.95); }

        .btn-secondary {
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            color: #374151;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: none;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .btn-secondary:active { transform: scale(0.95); }

        .btn-success {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(34, 197, 94, 0.4);
            border: none;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .btn-success:active { transform: scale(0.95); }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.4);
            border: none;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .btn-danger:active { transform: scale(0.95); }

        .symbol-btn {
            background: #f3f4f6;
            padding: 0.5rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            min-width: 40px;
            border: none;
            cursor: pointer;
            transition: background 0.1s;
        }
        .symbol-btn:active { background: #d1d5db; }

        .category-btn {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            white-space: nowrap;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        .category-btn.active {
            background: #3b82f6;
            color: white;
        }
        .category-btn:not(.active) {
            background: #e5e7eb;
            color: #374151;
        }

        .modal-overlay {
            background: rgba(0,0,0,0.5);
        }

        .ring-2 {
            box-shadow: 0 0 0 2px #3b82f6;
        }

        select, textarea, input[type="text"] {
            width: 100%;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 0.75rem;
            font-size: 1rem;
            outline: none;
        }
        select:focus, textarea:focus, input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.3s ease-out; }

        /* KaTeX æ ·å¼è°ƒæ•´ */
        .katex { font-size: 1.3em !important; }

        /* ç¦»çº¿æç¤º */
        .offline-banner {
            background: #fef3c7;
            color: #92400e;
            padding: 0.5rem;
            text-align: center;
            font-size: 0.875rem;
            display: none;
        }
        .offline-banner.show { display: block; }

        /* PWA å®‰è£…æç¤º */
        .install-prompt {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: white;
            border-radius: 1rem;
            padding: 1rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
        }
        .install-prompt.show { display: block; }
    </style>
</head>
<body>
    <!-- ç¦»çº¿æç¤º -->
    <div id="offlineBanner" class="offline-banner">
        ğŸ“´ å½“å‰å¤„äºç¦»çº¿æ¨¡å¼
    </div>

    <!-- ä¸»é¡µ -->
    <div id="homePage" class="page active p-4 pb-20">
        <div class="text-center py-8">
            <div class="text-5xl mb-3">ğŸ“</div>
            <h1 class="text-2xl font-bold text-gray-800">æ•°å­¦å…¬å¼èƒŒè¯µåŠ©æ‰‹</h1>
            <p class="text-gray-500 mt-2">é«˜æ•ˆè®°å¿†ï¼Œè½»æ¾æŒæ¡</p>
        </div>
        
        <div class="grid grid-cols-2 gap-4 mt-6">
            <div onclick="showPage('bankPage')" class="card cursor-pointer">
                <div class="text-3xl mb-2">ğŸ“š</div>
                <h3 class="font-bold text-gray-800">é¢˜åº“ç®¡ç†</h3>
                <p class="text-sm text-gray-500 mt-1">ç®¡ç†æ‰€æœ‰å…¬å¼</p>
            </div>
            <div onclick="showPage('setPage')" class="card cursor-pointer">
                <div class="text-3xl mb-2">ğŸ“</div>
                <h3 class="font-bold text-gray-800">é¢˜é›†ç®¡ç†</h3>
                <p class="text-sm text-gray-500 mt-1">åˆ›å»ºè‡ªå®šä¹‰é¢˜é›†</p>
            </div>
            <div onclick="showPage('memorizeSelectPage')" class="card cursor-pointer">
                <div class="text-3xl mb-2">ğŸ§ </div>
                <h3 class="font-bold text-gray-800">èƒŒè®°æ¨¡å¼</h3>
                <p class="text-sm text-gray-500 mt-1">ç³»ç»ŸåŒ–è®°å¿†</p>
            </div>
            <div onclick="showPage('practiceSelectPage')" class="card cursor-pointer">
                <div class="text-3xl mb-2">âœï¸</div>
                <h3 class="font-bold text-gray-800">ç»ƒä¹ æ¨¡å¼</h3>
                <p class="text-sm text-gray-500 mt-1">æ— é™å¾ªç¯ç»ƒä¹ </p>
            </div>
        </div>

        <div class="card mt-6">
            <h3 class="font-bold text-gray-800 mb-3">ğŸ“Š å­¦ä¹ ç»Ÿè®¡</h3>
            <div class="grid grid-cols-3 gap-3 text-center">
                <div class="bg-blue-50 rounded-xl p-3">
                    <div id="statFormulas" class="text-2xl font-bold text-blue-600">0</div>
                    <div class="text-xs text-gray-500">æ€»å…¬å¼æ•°</div>
                </div>
                <div class="bg-green-50 rounded-xl p-3">
                    <div id="statSets" class="text-2xl font-bold text-green-600">0</div>
                    <div class="text-xs text-gray-500">é¢˜é›†æ•°</div>
                </div>
                <div class="bg-purple-50 rounded-xl p-3">
                    <div id="statSessions" class="text-2xl font-bold text-purple-600">0</div>
                    <div class="text-xs text-gray-500">èƒŒè®°æ¬¡æ•°</div>
                </div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="flex items-center gap-2 text-green-600">
                <span>âœ…</span>
                <span class="text-sm">æ”¯æŒç¦»çº¿ä½¿ç”¨</span>
            </div>
        </div>
    </div>

    <!-- é¢˜åº“ç®¡ç†é¡µ -->
    <div id="bankPage" class="page p-4 pb-20">
        <div class="flex items-center justify-between mb-4">
            <button onclick="showPage('homePage')" class="text-blue-600 flex items-center">
                <span class="text-xl mr-1">â†</span> è¿”å›
            </button>
            <h2 class="text-xl font-bold">é¢˜åº“ç®¡ç†</h2>
            <button onclick="showAddFormula()" class="text-blue-600 text-2xl">+</button>
        </div>
        
        <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
            <button onclick="filterCategory('all')" class="category-btn active" data-cat="all">å…¨éƒ¨</button>
            <button onclick="filterCategory('derivative')" class="category-btn" data-cat="derivative">æ±‚å¯¼å…¬å¼</button>
            <button onclick="filterCategory('integral')" class="category-btn" data-cat="integral">ç§¯åˆ†å…¬å¼</button>
            <button onclick="filterCategory('custom')" class="category-btn" data-cat="custom">è‡ªå®šä¹‰</button>
        </div>

        <div id="formulaList" class="space-y-3"></div>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘å…¬å¼å¼¹çª— -->
    <div id="formulaModal" class="fixed inset-0 modal-overlay z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-md" style="max-height: 90vh; overflow-y: auto;">
            <div class="p-5">
                <h3 id="modalTitle" class="text-xl font-bold mb-4">æ·»åŠ å…¬å¼</h3>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">åˆ†ç±»</label>
                    <select id="formulaCategory">
                        <option value="derivative">æ±‚å¯¼å…¬å¼</option>
                        <option value="integral">ç§¯åˆ†å…¬å¼</option>
                        <option value="custom">è‡ªå®šä¹‰</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">å…¬å¼å·¦è¾¹ (ç­‰å·å‰)</label>
                    <textarea id="formulaLeft" class="h-20" placeholder="ä¾‹å¦‚: \frac{d}{dx}(x^n)"></textarea>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">å…¬å¼å³è¾¹ (ç­‰å·å)</label>
                    <textarea id="formulaRight" class="h-20" placeholder="ä¾‹å¦‚: nx^{n-1}"></textarea>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">å¸¸ç”¨ç¬¦å·</label>
                    <div class="grid grid-cols-6 gap-2">
                        <button onclick="insertSymbol('\\frac{}{}')" class="symbol-btn">Â½</button>
                        <button onclick="insertSymbol('^{}')" class="symbol-btn">xÂ²</button>
                        <button onclick="insertSymbol('_{}')" class="symbol-btn">xâ‚‚</button>
                        <button onclick="insertSymbol('\\sqrt{}')" class="symbol-btn">âˆš</button>
                        <button onclick="insertSymbol('\\int')" class="symbol-btn">âˆ«</button>
                        <button onclick="insertSymbol('\\sum')" class="symbol-btn">Î£</button>
                        <button onclick="insertSymbol('\\pi')" class="symbol-btn">Ï€</button>
                        <button onclick="insertSymbol('\\alpha')" class="symbol-btn">Î±</button>
                        <button onclick="insertSymbol('\\beta')" class="symbol-btn">Î²</button>
                        <button onclick="insertSymbol('\\theta')" class="symbol-btn">Î¸</button>
                        <button onclick="insertSymbol('\\infty')" class="symbol-btn">âˆ</button>
                        <button onclick="insertSymbol('\\pm')" class="symbol-btn">Â±</button>
                        <button onclick="insertSymbol('\\sin')" class="symbol-btn">sin</button>
                        <button onclick="insertSymbol('\\cos')" class="symbol-btn">cos</button>
                        <button onclick="insertSymbol('\\tan')" class="symbol-btn">tan</button>
                        <button onclick="insertSymbol('\\ln')" class="symbol-btn">ln</button>
                        <button onclick="insertSymbol('\\log')" class="symbol-btn">log</button>
                        <button onclick="insertSymbol('e^{}')" class="symbol-btn">eË£</button>
                        <button onclick="insertSymbol('\\lim')" class="symbol-btn">lim</button>
                        <button onclick="insertSymbol('\\to')" class="symbol-btn">â†’</button>
                        <button onclick="insertSymbol('\\cdot')" class="symbol-btn">Â·</button>
                        <button onclick="insertSymbol('\\times')" class="symbol-btn">Ã—</button>
                        <button onclick="insertSymbol('\\div')" class="symbol-btn">Ã·</button>
                        <button onclick="insertSymbol('\\neq')" class="symbol-btn">â‰ </button>
                    </div>
                </div>

                <div class="mb-4 p-4 bg-gray-50 rounded-xl">
                    <label class="block text-sm font-medium text-gray-700 mb-2">é¢„è§ˆ</label>
                    <div id="formulaPreview" class="formula-display text-xl"></div>
                </div>

                <div class="flex gap-3">
                    <button onclick="closeFormulaModal()" class="flex-1 btn-secondary">å–æ¶ˆ</button>
                    <button onclick="saveFormula()" class="flex-1 btn-primary">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- é¢˜é›†ç®¡ç†é¡µ -->
    <div id="setPage" class="page p-4 pb-20">
        <div class="flex items-center justify-between mb-4">
            <button onclick="showPage('homePage')" class="text-blue-600 flex items-center">
                <span class="text-xl mr-1">â†</span> è¿”å›
            </button>
            <h2 class="text-xl font-bold">é¢˜é›†ç®¡ç†</h2>
            <button onclick="showCreateSet()" class="text-blue-600 text-2xl">+</button>
        </div>
        
        <div id="setList" class="space-y-3"></div>
    </div>

    <!-- åˆ›å»ºé¢˜é›†é¡µ -->
    <div id="createSetPage" class="page p-4 pb-20">
        <div class="flex items-center justify-between mb-4">
            <button onclick="showPage('setPage')" class="text-blue-600 flex items-center">
                <span class="text-xl mr-1">â†</span> è¿”å›
            </button>
            <h2 class="text-xl font-bold">åˆ›å»ºé¢˜é›†</h2>
            <button onclick="saveSet()" class="text-blue-600 font-medium">ä¿å­˜</button>
        </div>

        <div class="card">
            <input id="setName" type="text" placeholder="è¾“å…¥é¢˜é›†åç§°" style="border: none; border-bottom: 1px solid #e5e7eb; border-radius: 0; padding: 0.5rem 0; font-size: 1.125rem; font-weight: 500;">
            <p class="text-sm text-gray-500 mt-2">å·²é€‰æ‹© <span id="selectedCount">0</span> ä¸ªå…¬å¼</p>
        </div>

        <div class="flex gap-2 mb-4">
            <button onclick="selectAllFormulas()" class="text-sm bg-blue-100 text-blue-600 px-3 py-1 rounded-full border-none cursor-pointer">å…¨é€‰</button>
            <button onclick="deselectAllFormulas()" class="text-sm bg-gray-100 text-gray-600 px-3 py-1 rounded-full border-none cursor-pointer">å–æ¶ˆå…¨é€‰</button>
        </div>

        <div id="formulaSelectList" class="space-y-3"></div>
    </div>

    <!-- èƒŒè®°æ¨¡å¼é€‰æ‹©é¡µ -->
    <div id="memorizeSelectPage" class="page p-4 pb-20">
        <div class="flex items-center justify-between mb-4">
            <button onclick="showPage('homePage')" class="text-blue-600 flex items-center">
                <span class="text-xl mr-1">â†</span> è¿”å›
            </button>
            <h2 class="text-xl font-bold">é€‰æ‹©é¢˜é›†</h2>
            <div class="w-10"></div>
        </div>
        
        <p class="text-gray-500 mb-4">é€‰æ‹©ä¸€ä¸ªé¢˜é›†å¼€å§‹èƒŒè®°</p>
        <div id="memorizeSetList" class="space-y-3"></div>
    </div>

    <!-- èƒŒè®°æ¨¡å¼é¡µ -->
    <div id="memorizePage" class="page min-h-screen flex flex-col">
        <div class="bg-white shadow-sm p-4 flex justify-between items-center">
            <button onclick="exitMemorize()" class="text-red-500 font-medium">é€€å‡º</button>
            <div class="text-center">
                <div class="text-sm text-gray-500">è¿›åº¦</div>
                <div id="memorizeProgress" class="font-bold">0/0</div>
            </div>
            <div class="text-center">
                <div class="text-sm text-gray-500">ä¸è®°å¾—</div>
                <div id="memorizeWrong" class="font-bold text-red-500">0</div>
            </div>
        </div>
        
        <div id="memorizeArea" class="flex-1 flex flex-col items-center justify-center p-6" onclick="handleMemorizeClick()">
            <div class="card w-full max-w-md">
                <div id="memorizeFormula" class="formula-display text-2xl" style="min-height: 150px;"></div>
            </div>
            <p id="memorizeHint" class="text-gray-400 mt-4">ç‚¹å‡»å±å¹•æŸ¥çœ‹ç­”æ¡ˆ</p>
        </div>

        <div id="memorizeButtons" class="hidden p-4 bg-white shadow-lg">
            <div class="flex gap-4">
                <button onclick="memorizeAnswer(false)" class="flex-1 btn-danger py-4 text-lg">ğŸ˜• ä¸è®°å¾—</button>
                <button onclick="memorizeAnswer(true)" class="flex-1 btn-success py-4 text-lg">ğŸ˜Š è®°å¾—</button>
            </div>
        </div>
    </div>

    <!-- èƒŒè®°ç»“æœé¡µ -->
    <div id="memorizeResultPage" class="page p-4 pb-20">
        <div class="text-center py-8">
            <div class="text-6xl mb-4">ğŸ‰</div>
            <h2 class="text-2xl font-bold text-gray-800">èƒŒè®°å®Œæˆï¼</h2>
        </div>

        <div class="card">
            <h3 class="font-bold text-gray-800 mb-4">ğŸ“Š æœ¬æ¬¡ç»Ÿè®¡</h3>
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-blue-50 rounded-xl p-4 text-center">
                    <div id="resultTotal" class="text-3xl font-bold text-blue-600">0</div>
                    <div class="text-sm text-gray-500">æ€»å…¬å¼æ•°</div>
                </div>
                <div class="bg-green-50 rounded-xl p-4 text-center">
                    <div id="resultRepeats" class="text-3xl font-bold text-green-600">0</div>
                    <div class="text-sm text-gray-500">é‡å¤æ¬¡æ•°</div>
                </div>
                <div class="bg-red-50 rounded-xl p-4 text-center">
                    <div id="resultWrong" class="text-3xl font-bold text-red-600">0</div>
                    <div class="text-sm text-gray-500">ä¸è®°å¾—æ¬¡æ•°</div>
                </div>
                <div class="bg-purple-50 rounded-xl p-4 text-center">
                    <div id="resultAccuracy" class="text-3xl font-bold text-purple-600">0%</div>
                    <div class="text-sm text-gray-500">æ­£ç¡®ç‡</div>
                </div>
            </div>
        </div>

        <div id="wrongFormulasList" class="card hidden">
            <h3 class="font-bold text-gray-800 mb-4">âŒ ä¸è®°å¾—çš„å…¬å¼</h3>
            <div id="wrongFormulas" class="space-y-3"></div>
        </div>

        <button onclick="showPage('homePage')" class="w-full btn-primary mt-6 py-4 text-lg">è¿”å›é¦–é¡µ</button>
    </div>

    <!-- ç»ƒä¹ æ¨¡å¼é€‰æ‹©é¡µ -->
    <div id="practiceSelectPage" class="page p-4 pb-20">
        <div class="flex items-center justify-between mb-4">
            <button onclick="showPage('homePage')" class="text-blue-600 flex items-center">
                <span class="text-xl mr-1">â†</span> è¿”å›
            </button>
            <h2 class="text-xl font-bold">é€‰æ‹©é¢˜é›†</h2>
            <div class="w-10"></div>
        </div>
        
        <p class="text-gray-500 mb-4">é€‰æ‹©ä¸€ä¸ªé¢˜é›†å¼€å§‹ç»ƒä¹ </p>
        <div id="practiceSetList" class="space-y-3"></div>
    </div>

    <!-- ç»ƒä¹ æ¨¡å¼é¡µ -->
    <div id="practicePage" class="page min-h-screen flex flex-col">
        <div class="bg-white shadow-sm p-4 flex justify-between items-center">
            <button onclick="exitPractice()" class="btn-danger text-sm px-4 py-2">é€€å‡ºç»ƒä¹ </button>
            <div class="text-center">
                <div class="text-sm text-gray-500">å·²ç»ƒä¹ </div>
                <div id="practiceCount" class="font-bold">0</div>
            </div>
        </div>
        
        <div id="practiceArea" class="flex-1 flex flex-col items-center justify-center p-6" onclick="handlePracticeClick()">
            <div class="card w-full max-w-md">
                <div id="practiceFormula" class="formula-display text-2xl" style="min-height: 150px;"></div>
            </div>
            <p id="practiceHint" class="text-gray-400 mt-4">ç‚¹å‡»å±å¹•æŸ¥çœ‹ç­”æ¡ˆ</p>
        </div>
    </div>

    <!-- KaTeX JS - å°†è¢«ç¼“å­˜ä¾›ç¦»çº¿ä½¿ç”¨ -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>

    <script>
        // æ•°æ®å­˜å‚¨
        let formulas = [];
        let sets = [];
        let stats = { sessions: 0 };
        let currentEditId = null;
        let currentEditSetId = null;
        let selectedFormulas = new Set();
        let lastFocusedInput = null;

        // èƒŒè®°æ¨¡å¼çŠ¶æ€
        let memorizeState = {
            formulas: [],
            queue: [],
            current: null,
            showingAnswer: false,
            wrongCount: 0,
            wrongFormulas: {},
            totalShown: 0
        };

        // ç»ƒä¹ æ¨¡å¼çŠ¶æ€
        let practiceState = {
            formulas: [],
            current: null,
            showingAnswer: false,
            count: 0
        };

        // é»˜è®¤å…¬å¼åº“
        const defaultFormulas = [
            // åŸºæœ¬æ±‚å¯¼å…¬å¼
            { id: 1, category: 'derivative', left: "(c)'", right: "0", builtin: true },
            { id: 2, category: 'derivative', left: "(x^n)'", right: "nx^{n-1}", builtin: true },
            { id: 3, category: 'derivative', left: "(\\sin x)'", right: "\\cos x", builtin: true },
            { id: 4, category: 'derivative', left: "(\\cos x)'", right: "-\\sin x", builtin: true },
            { id: 5, category: 'derivative', left: "(\\tan x)'", right: "\\sec^2 x", builtin: true },
            { id: 6, category: 'derivative', left: "(\\cot x)'", right: "-\\csc^2 x", builtin: true },
            { id: 7, category: 'derivative', left: "(\\sec x)'", right: "\\sec x \\tan x", builtin: true },
            { id: 8, category: 'derivative', left: "(\\csc x)'", right: "-\\csc x \\cot x", builtin: true },
            { id: 9, category: 'derivative', left: "(a^x)'", right: "a^x \\ln a", builtin: true },
            { id: 10, category: 'derivative', left: "(e^x)'", right: "e^x", builtin: true },
            { id: 11, category: 'derivative', left: "(\\log_a x)'", right: "\\frac{1}{x \\ln a}", builtin: true },
            { id: 12, category: 'derivative', left: "(\\ln x)'", right: "\\frac{1}{x}", builtin: true },
            { id: 13, category: 'derivative', left: "(\\arcsin x)'", right: "\\frac{1}{\\sqrt{1-x^2}}", builtin: true },
            { id: 14, category: 'derivative', left: "(\\arccos x)'", right: "-\\frac{1}{\\sqrt{1-x^2}}", builtin: true },
            { id: 15, category: 'derivative', left: "(\\arctan x)'", right: "\\frac{1}{1+x^2}", builtin: true },
            { id: 16, category: 'derivative', left: "(\\text{arccot}\\ x)'", right: "-\\frac{1}{1+x^2}", builtin: true },
            // åŸºæœ¬ç§¯åˆ†å…¬å¼
            { id: 17, category: 'integral', left: "\\int k\\,dx", right: "kx + C", builtin: true },
            { id: 18, category: 'integral', left: "\\int x^n\\,dx", right: "\\frac{x^{n+1}}{n+1} + C\\ (n \\neq -1)", builtin: true },
            { id: 19, category: 'integral', left: "\\int \\frac{1}{x}\\,dx", right: "\\ln|x| + C", builtin: true },
            { id: 20, category: 'integral', left: "\\int e^x\\,dx", right: "e^x + C", builtin: true },
            { id: 21, category: 'integral', left: "\\int a^x\\,dx", right: "\\frac{a^x}{\\ln a} + C", builtin: true },
            { id: 22, category: 'integral', left: "\\int \\sin x\\,dx", right: "-\\cos x + C", builtin: true },
            { id: 23, category: 'integral', left: "\\int \\cos x\\,dx", right: "\\sin x + C", builtin: true },
            { id: 24, category: 'integral', left: "\\int \\tan x\\,dx", right: "-\\ln|\\cos x| + C", builtin: true },
            { id: 25, category: 'integral', left: "\\int \\cot x\\,dx", right: "\\ln|\\sin x| + C", builtin: true },
            { id: 26, category: 'integral', left: "\\int \\sec^2 x\\,dx", right: "\\tan x + C", builtin: true },
            { id: 27, category: 'integral', left: "\\int \\csc^2 x\\,dx", right: "-\\cot x + C", builtin: true },
            { id: 28, category: 'integral', left: "\\int \\sec x \\tan x\\,dx", right: "\\sec x + C", builtin: true },
            { id: 29, category: 'integral', left: "\\int \\csc x \\cot x\\,dx", right: "-\\csc x + C", builtin: true },
            { id: 30, category: 'integral', left: "\\int \\frac{1}{\\sqrt{1-x^2}}\\,dx", right: "\\arcsin x + C", builtin: true },
            { id: 31, category: 'integral', left: "\\int \\frac{1}{1+x^2}\\,dx", right: "\\arctan x + C", builtin: true },
            { id: 32, category: 'integral', left: "\\int \\frac{1}{\\sqrt{x^2+a^2}}\\,dx", right: "\\ln(x+\\sqrt{x^2+a^2}) + C", builtin: true },
            { id: 33, category: 'integral', left: "\\int \\frac{1}{\\sqrt{x^2-a^2}}\\,dx", right: "\\ln|x+\\sqrt{x^2-a^2}| + C", builtin: true },
        ];

        // åˆå§‹åŒ–
        function init() {
            loadData();
            if (formulas.length === 0) {
                formulas = [...defaultFormulas];
                saveData();
            }
            updateStats();
            renderFormulaList();
            renderSetList();
            
            // æ³¨å†Œ Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker æ³¨å†ŒæˆåŠŸ'))
                    .catch(err => console.log('Service Worker æ³¨å†Œå¤±è´¥:', err));
            }

            // ç›‘å¬ç¦»çº¿/åœ¨çº¿çŠ¶æ€
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            updateOnlineStatus();
        }

        function updateOnlineStatus() {
            const banner = document.getElementById('offlineBanner');
            if (navigator.onLine) {
                banner.classList.remove('show');
            } else {
                banner.classList.add('show');
            }
        }

        // æ•°æ®æŒä¹…åŒ–
        function loadData() {
            try {
                const savedFormulas = localStorage.getItem('mathFormulas');
                const savedSets = localStorage.getItem('mathSets');
                const savedStats = localStorage.getItem('mathStats');
                if (savedFormulas) formulas = JSON.parse(savedFormulas);
                if (savedSets) sets = JSON.parse(savedSets);
                if (savedStats) stats = JSON.parse(savedStats);
            } catch (e) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', e);
            }
        }

        function saveData() {
            try {
                localStorage.setItem('mathFormulas', JSON.stringify(formulas));
                localStorage.setItem('mathSets', JSON.stringify(sets));
                localStorage.setItem('mathStats', JSON.stringify(stats));
            } catch (e) {
                console.error('ä¿å­˜æ•°æ®å¤±è´¥:', e);
            }
        }

        // é¡µé¢åˆ‡æ¢
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            if (pageId === 'homePage') updateStats();
            if (pageId === 'bankPage') renderFormulaList();
            if (pageId === 'setPage') renderSetList();
            if (pageId === 'memorizeSelectPage' || pageId === 'practiceSelectPage') {
                renderModeSetList(pageId === 'memorizeSelectPage' ? 'memorizeSetList' : 'practiceSetList', 
                                  pageId === 'memorizeSelectPage' ? 'memorize' : 'practice');
            }
        }

        // æ›´æ–°ç»Ÿè®¡
        function updateStats() {
            document.getElementById('statFormulas').textContent = formulas.length;
            document.getElementById('statSets').textContent = sets.length;
            document.getElementById('statSessions').textContent = stats.sessions;
        }

        // ä½¿ç”¨ KaTeX æ¸²æŸ“å…¬å¼
        function renderMath(element) {
            if (typeof katex === 'undefined') {
                // å¦‚æœ KaTeX è¿˜æ²¡åŠ è½½å®Œæˆï¼Œç­‰å¾…åé‡è¯•
                setTimeout(() => renderMath(element), 100);
                return;
            }
            
            const mathElements = element.querySelectorAll('.formula-display, .formula-item');
            mathElements.forEach(el => {
                const text = el.textContent || el.innerText;
                if (text.includes('$')) {
                    const parts = text.split('$');
                    let html = '';
                    for (let i = 0; i < parts.length; i++) {
                        if (i % 2 === 1) {
                            try {
                                html += katex.renderToString(parts[i], { throwOnError: false });
                            } catch (e) {
                                html += parts[i];
                            }
                        } else {
                            html += parts[i];
                        }
                    }
                    el.innerHTML = html;
                }
            });
        }

        function renderSingleFormula(latex) {
            if (typeof katex === 'undefined') return latex;
            try {
                return katex.renderToString(latex, { throwOnError: false, displayMode: true });
            } catch (e) {
                return latex;
            }
        }

        // é¢˜åº“ç®¡ç†
        let currentCategory = 'all';

        function filterCategory(cat) {
            currentCategory = cat;
            document.querySelectorAll('.category-btn').forEach(btn => {
                if (btn.dataset.cat === cat) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            renderFormulaList();
        }

        function renderFormulaList() {
            const list = document.getElementById('formulaList');
            const filtered = currentCategory === 'all' ? formulas : formulas.filter(f => f.category === currentCategory);
            
            list.innerHTML = filtered.map(f => `
                <div class="card fade-in">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs px-2 py-1 rounded-full ${getCategoryClass(f.category)}">${getCategoryName(f.category)}</span>
                        <div class="flex gap-2">
                            <button onclick="editFormula(${f.id})" class="text-blue-500 text-sm" style="border:none;background:none;cursor:pointer;">ç¼–è¾‘</button>
                            <button onclick="deleteFormula(${f.id})" class="text-red-500 text-sm" style="border:none;background:none;cursor:pointer;">åˆ é™¤</button>
                        </div>
                    </div>
                    <div class="formula-display text-lg">$${f.left} = ${f.right}$</div>
                </div>
            `).join('');
            
            renderMath(list);
        }

        function getCategoryName(cat) {
            const names = { derivative: 'æ±‚å¯¼', integral: 'ç§¯åˆ†', custom: 'è‡ªå®šä¹‰' };
            return names[cat] || cat;
        }

        function getCategoryClass(cat) {
            const classes = { 
                derivative: 'bg-blue-100 text-blue-600',
                integral: 'bg-green-100 text-green-600',
                custom: 'bg-purple-100 text-purple-600'
            };
            return classes[cat] || 'bg-gray-100 text-gray-700';
        }

        function showAddFormula() {
            currentEditId = null;
            document.getElementById('modalTitle').textContent = 'æ·»åŠ å…¬å¼';
            document.getElementById('formulaCategory').value = 'custom';
            document.getElementById('formulaLeft').value = '';
            document.getElementById('formulaRight').value = '';
            document.getElementById('formulaPreview').innerHTML = '';
            document.getElementById('formulaModal').classList.remove('hidden');
            document.getElementById('formulaModal').style.display = 'flex';
        }

        function editFormula(id) {
            const formula = formulas.find(f => f.id === id);
            if (!formula) return;
            
            currentEditId = id;
            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘å…¬å¼';
            document.getElementById('formulaCategory').value = formula.category;
            document.getElementById('formulaLeft').value = formula.left;
            document.getElementById('formulaRight').value = formula.right;
            updatePreview();
            document.getElementById('formulaModal').classList.remove('hidden');
            document.getElementById('formulaModal').style.display = 'flex';
        }

        function closeFormulaModal() {
            document.getElementById('formulaModal').classList.add('hidden');
            document.getElementById('formulaModal').style.display = 'none';
        }

        function saveFormula() {
            const category = document.getElementById('formulaCategory').value;
            const left = document.getElementById('formulaLeft').value.trim();
            const right = document.getElementById('formulaRight').value.trim();
            
            if (!left || !right) {
                alert('è¯·å¡«å†™å®Œæ•´çš„å…¬å¼');
                return;
            }

            if (currentEditId) {
                const formula = formulas.find(f => f.id === currentEditId);
                if (formula) {
                    formula.category = category;
                    formula.left = left;
                    formula.right = right;
                }
            } else {
                const newId = Math.max(0, ...formulas.map(f => f.id)) + 1;
                formulas.push({ id: newId, category, left, right, builtin: false });
            }

            saveData();
            closeFormulaModal();
            renderFormulaList();
        }

        function deleteFormula(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå…¬å¼å—ï¼Ÿ')) {
                formulas = formulas.filter(f => f.id !== id);
                sets.forEach(set => {
                    set.formulaIds = set.formulaIds.filter(fid => fid !== id);
                });
                saveData();
                renderFormulaList();
            }
        }

        function insertSymbol(symbol) {
            const leftInput = document.getElementById('formulaLeft');
            const rightInput = document.getElementById('formulaRight');
            const activeElement = document.activeElement;
            
            let input = leftInput;
            if (activeElement === rightInput) {
                input = rightInput;
            } else if (lastFocusedInput) {
                input = lastFocusedInput;
            }
            
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const value = input.value;
            input.value = value.substring(0, start) + symbol + value.substring(end);
            input.focus();
            const newPos = start + symbol.length;
            input.setSelectionRange(newPos, newPos);
            updatePreview();
        }

        document.getElementById('formulaLeft').addEventListener('focus', function() {
            lastFocusedInput = this;
        });
        document.getElementById('formulaRight').addEventListener('focus', function() {
            lastFocusedInput = this;
        });

        function updatePreview() {
            const left = document.getElementById('formulaLeft').value;
            const right = document.getElementById('formulaRight').value;
            const preview = document.getElementById('formulaPreview');
            const fullFormula = left + ' = ' + right;
            preview.innerHTML = renderSingleFormula(fullFormula);
        }

        document.getElementById('formulaLeft').addEventListener('input', updatePreview);
        document.getElementById('formulaRight').addEventListener('input', updatePreview);

        // é¢˜é›†ç®¡ç†
        function renderSetList() {
            const list = document.getElementById('setList');
            if (sets.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-400 py-10">æš‚æ— é¢˜é›†ï¼Œç‚¹å‡»å³ä¸Šè§’åˆ›å»º</div>';
                return;
            }
            
            list.innerHTML = sets.map(s => `
                <div class="card fade-in">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="font-bold text-gray-800">${s.name}</h3>
                            <p class="text-sm text-gray-500">${s.formulaIds.length} ä¸ªå…¬å¼</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editSet(${s.id})" class="text-blue-500 text-sm" style="border:none;background:none;cursor:pointer;">ç¼–è¾‘</button>
                            <button onclick="deleteSet(${s.id})" class="text-red-500 text-sm" style="border:none;background:none;cursor:pointer;">åˆ é™¤</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showCreateSet() {
            currentEditSetId = null;
            selectedFormulas = new Set();
            document.getElementById('setName').value = '';
            renderFormulaSelectList();
            showPage('createSetPage');
        }

        function editSet(id) {
            const set = sets.find(s => s.id === id);
            if (!set) return;
            
            currentEditSetId = id;
            selectedFormulas = new Set(set.formulaIds);
            document.getElementById('setName').value = set.name;
            renderFormulaSelectList();
            showPage('createSetPage');
        }

        function renderFormulaSelectList() {
            const list = document.getElementById('formulaSelectList');
            list.innerHTML = formulas.map(f => `
                <div class="card cursor-pointer ${selectedFormulas.has(f.id) ? 'ring-2' : ''}" onclick="toggleFormula(${f.id})">
                    <div class="flex items-center gap-3">
                        <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center ${selectedFormulas.has(f.id) ? 'bg-blue-500 border-blue-500' : 'border-gray-300'}" style="min-width:24px;">
                            ${selectedFormulas.has(f.id) ? '<span class="text-white text-sm">âœ“</span>' : ''}
                        </div>
                        <div class="flex-1">
                            <span class="text-xs px-2 py-1 rounded-full ${getCategoryClass(f.category)}">${getCategoryName(f.category)}</span>
                            <div class="formula-display text-sm mt-1">$${f.left} = ${f.right}$</div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('selectedCount').textContent = selectedFormulas.size;
            renderMath(list);
        }

        function toggleFormula(id) {
            if (selectedFormulas.has(id)) {
                selectedFormulas.delete(id);
            } else {
                selectedFormulas.add(id);
            }
            renderFormulaSelectList();
        }

        function selectAllFormulas() {
            formulas.forEach(f => selectedFormulas.add(f.id));
            renderFormulaSelectList();
        }

        function deselectAllFormulas() {
            selectedFormulas.clear();
            renderFormulaSelectList();
        }

        function saveSet() {
            const name = document.getElementById('setName').value.trim();
            if (!name) {
                alert('è¯·è¾“å…¥é¢˜é›†åç§°');
                return;
            }
            if (selectedFormulas.size === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå…¬å¼');
                return;
            }

            if (currentEditSetId) {
                const set = sets.find(s => s.id === currentEditSetId);
                if (set) {
                    set.name = name;
                    set.formulaIds = [...selectedFormulas];
                }
            } else {
                const newId = Math.max(0, ...sets.map(s => s.id)) + 1;
                sets.push({ id: newId, name, formulaIds: [...selectedFormulas] });
            }

            saveData();
            showPage('setPage');
        }

        function deleteSet(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¢˜é›†å—ï¼Ÿ')) {
                sets = sets.filter(s => s.id !== id);
                saveData();
                renderSetList();
            }
        }

        // æ¨¡å¼é€‰æ‹©é¡µæ¸²æŸ“
        function renderModeSetList(listId, mode) {
            const list = document.getElementById(listId);
            
            let html = `
                <div class="card cursor-pointer" onclick="start${mode === 'memorize' ? 'Memorize' : 'Practice'}(-1)">
                    <div class="flex items-center gap-3">
                        <div class="text-3xl">ğŸ“š</div>
                        <div>
                            <h3 class="font-bold text-gray-800">å…¨éƒ¨é¢˜åº“</h3>
                            <p class="text-sm text-gray-500">${formulas.length} ä¸ªå…¬å¼</p>
                        </div>
                    </div>
                </div>
            `;
            
            html += sets.map(s => `
                <div class="card cursor-pointer" onclick="start${mode === 'memorize' ? 'Memorize' : 'Practice'}(${s.id})">
                    <div class="flex items-center gap-3">
                        <div class="text-3xl">ğŸ“</div>
                        <div>
                            <h3 class="font-bold text-gray-800">${s.name}</h3>
                            <p class="text-sm text-gray-500">${s.formulaIds.length} ä¸ªå…¬å¼</p>
                        </div>
                    </div>
                </div>
            `).join('');
            
            list.innerHTML = html;
        }

        // èƒŒè®°æ¨¡å¼
        function startMemorize(setId) {
            let targetFormulas;
            if (setId === -1) {
                targetFormulas = [...formulas];
            } else {
                const set = sets.find(s => s.id === setId);
                if (!set || set.formulaIds.length === 0) {
                    alert('é¢˜é›†ä¸ºç©º');
                    return;
                }
                targetFormulas = formulas.filter(f => set.formulaIds.includes(f.id));
            }

            memorizeState = {
                formulas: targetFormulas,
                queue: [],
                current: null,
                showingAnswer: false,
                wrongCount: 0,
                wrongFormulas: {},
                totalShown: 0
            };

            for (let i = 0; i < 3; i++) {
                memorizeState.queue.push(...targetFormulas.map(f => f.id));
            }
            shuffleArray(memorizeState.queue);

            document.getElementById('memorizeProgress').textContent = `0/${memorizeState.queue.length}`;
            document.getElementById('memorizeWrong').textContent = '0';
            
            showPage('memorizePage');
            nextMemorizeFormula();
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function nextMemorizeFormula() {
            if (memorizeState.queue.length === 0) {
                finishMemorize();
                return;
            }

            const formulaId = memorizeState.queue.shift();
            memorizeState.current = memorizeState.formulas.find(f => f.id === formulaId);
            memorizeState.showingAnswer = false;
            memorizeState.totalShown++;

            const display = document.getElementById('memorizeFormula');
            display.innerHTML = renderSingleFormula(memorizeState.current.left + ' = \\ ?');

            document.getElementById('memorizeHint').textContent = 'ç‚¹å‡»å±å¹•æŸ¥çœ‹ç­”æ¡ˆ';
            document.getElementById('memorizeButtons').classList.add('hidden');
            document.getElementById('memorizeProgress').textContent = `${memorizeState.totalShown}/${memorizeState.totalShown + memorizeState.queue.length}`;
        }

        function handleMemorizeClick() {
            if (memorizeState.showingAnswer) return;
            
            memorizeState.showingAnswer = true;
            const display = document.getElementById('memorizeFormula');
            display.innerHTML = renderSingleFormula(memorizeState.current.left + ' = ' + memorizeState.current.right);

            document.getElementById('memorizeHint').textContent = '';
            document.getElementById('memorizeButtons').classList.remove('hidden');
        }

        function memorizeAnswer(remembered) {
            if (!remembered) {
                memorizeState.wrongCount++;
                const id = memorizeState.current.id;
                memorizeState.wrongFormulas[id] = (memorizeState.wrongFormulas[id] || 0) + 1;
                document.getElementById('memorizeWrong').textContent = memorizeState.wrongCount;
            }
            nextMemorizeFormula();
        }

        function finishMemorize() {
            stats.sessions++;
            saveData();

            const totalFormulas = memorizeState.formulas.length;
            const totalShown = memorizeState.totalShown;
            const wrongCount = memorizeState.wrongCount;
            const accuracy = totalShown > 0 ? Math.round(((totalShown - wrongCount) / totalShown) * 100) : 0;

            document.getElementById('resultTotal').textContent = totalFormulas;
            document.getElementById('resultRepeats').textContent = totalShown;
            document.getElementById('resultWrong').textContent = wrongCount;
            document.getElementById('resultAccuracy').textContent = accuracy + '%';

            const wrongList = document.getElementById('wrongFormulas');
            const wrongIds = Object.keys(memorizeState.wrongFormulas);
            
            if (wrongIds.length > 0) {
                document.getElementById('wrongFormulasList').classList.remove('hidden');
                wrongList.innerHTML = wrongIds.map(id => {
                    const formula = formulas.find(f => f.id === parseInt(id));
                    const count = memorizeState.wrongFormulas[id];
                    return `
                        <div class="bg-red-50 rounded-xl p-3">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-xs text-red-600">ä¸è®°å¾— ${count} æ¬¡</span>
                            </div>
                            <div class="formula-display text-sm">$${formula.left} = ${formula.right}$</div>
                        </div>
                    `;
                }).join('');
                renderMath(wrongList);
            } else {
                document.getElementById('wrongFormulasList').classList.add('hidden');
            }

            showPage('memorizeResultPage');
        }

        function exitMemorize() {
            if (confirm('ç¡®å®šè¦é€€å‡ºèƒŒè®°å—ï¼Ÿå½“å‰è¿›åº¦å°†ä¸ä¼šä¿å­˜ã€‚')) {
                showPage('homePage');
            }
        }

        // ç»ƒä¹ æ¨¡å¼
        function startPractice(setId) {
            let targetFormulas;
            if (setId === -1) {
                targetFormulas = [...formulas];
            } else {
                const set = sets.find(s => s.id === setId);
                if (!set || set.formulaIds.length === 0) {
                    alert('é¢˜é›†ä¸ºç©º');
                    return;
                }
                targetFormulas = formulas.filter(f => set.formulaIds.includes(f.id));
            }

            practiceState = {
                formulas: targetFormulas,
                current: null,
                showingAnswer: false,
                count: 0
            };

            document.getElementById('practiceCount').textContent = '0';
            showPage('practicePage');
            nextPracticeFormula();
        }

        function nextPracticeFormula() {
            const randomIndex = Math.floor(Math.random() * practiceState.formulas.length);
            practiceState.current = practiceState.formulas[randomIndex];
            practiceState.showingAnswer = false;
            practiceState.count++;

            const display = document.getElementById('practiceFormula');
            display.innerHTML = renderSingleFormula(practiceState.current.left + ' = \\ ?');

            document.getElementById('practiceHint').textContent = 'ç‚¹å‡»å±å¹•æŸ¥çœ‹ç­”æ¡ˆ';
            document.getElementById('practiceCount').textContent = practiceState.count;
        }

        function handlePracticeClick() {
            if (!practiceState.showingAnswer) {
                practiceState.showingAnswer = true;
                const display = document.getElementById('practiceFormula');
                display.innerHTML = renderSingleFormula(practiceState.current.left + ' = ' + practiceState.current.right);
                document.getElementById('practiceHint').textContent = 'ç‚¹å‡»å±å¹•ä¸‹ä¸€é¢˜';
            } else {
                nextPracticeFormula();
            }
        }

        function exitPractice() {
            showPage('homePage');
        }

        // åˆå§‹åŒ–åº”ç”¨
        init();
    </script>
</body>
</html>
